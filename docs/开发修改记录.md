# 开发修改记录

## 2025-09-09 12:15 - Q CLI集成功能

### 修改内容
**功能描述**：集成Amazon Q CLI作为第二个AI服务选项，支持用户在DeepSeek API和Q CLI之间切换

### 涉及文件
1. **server.js** - 后端服务器
2. **src/App.jsx** - 前端React应用
3. **AI私人助理 — MVP PRD.md** - 产品需求文档

### 具体修改

#### 后端修改 (server.js)
- **新增导入**：添加 `child_process` 的 `spawn` 方法
- **会话管理**：
  - 新增 `qSessions` Map 存储Q CLI会话
  - 实现会话超时清理机制（10分钟）
  - 添加 `getQSession()` 函数管理Q CLI进程
- **新增API端点**：
  - `/api/chat-with-q` - Q CLI对话接口
  - `/api/q-status` - Q CLI状态检查接口
- **错误处理**：Q CLI不可用时的降级处理

#### 前端修改 (src/App.jsx)
- **状态管理**：
  - 新增 `aiService` 状态（deepseek/qcli）
  - 新增 `qCliStatus` 状态跟踪Q CLI可用性
- **新增函数**：
  - `checkQCliStatus()` - 检查Q CLI状态
  - `chatWithQCli()` - Q CLI对话函数
  - `chatWithDeepSeek()` - 重构DeepSeek对话函数
- **修改函数**：
  - `generateAIResponse()` - 支持多AI服务选择和自动降级
- **界面更新**：
  - 设置页面：添加AI服务选择下拉框和Q CLI状态显示
  - 对话界面：标题栏显示当前使用的AI服务

#### PRD文档更新
- 新增"AI服务集成"功能模块
- 更新技术边界说明
- 新增设置界面交互说明
- 更新MVP范围总结

### 功能特性
1. **多AI服务支持**：用户可选择DeepSeek或Q CLI
2. **自动降级**：Q CLI不可用时自动切换到DeepSeek
3. **状态监控**：实时显示AI服务状态
4. **会话管理**：Q CLI会话自动管理和清理
5. **用户体验**：界面显示当前使用的AI服务

### 技术实现要点
- Q CLI通过子进程调用，无需额外API密钥
- 使用AWS系统认证，依赖用户已配置的AWS凭证
- 进程池管理避免重复创建Q CLI进程
- 错误处理和超时机制保证系统稳定性

### 可能影响
- 需要用户系统中安装并配置Q CLI
- Q CLI不可用时会自动降级到DeepSeek
- 增加了系统复杂度，但提供了更多选择

### 注意事项
- Q CLI集成依赖系统环境，需要确保Q CLI可执行
- 会话管理需要合理的超时设置避免资源泄露
- 错误处理需要覆盖各种异常情况

---
